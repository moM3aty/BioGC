@model BioGC.ViewModels.ProfileViewModel
@{
    ViewData["Title"] = "User Profile";
    // <-- تم إضافة هذا القاموس لترجمة أسماء الأدوار -->
    var roleTranslations = new Dictionary<string, string>
    {
        { "Admin", "مدير" },
        { "Customer", "عميل" },
        { "PremiumUser", "عضو مميز" }
    };
}
<style>
    .wishlist-product-card {
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }

        .wishlist-product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .wishlist-product-card .product-image {
            height: 200px;
            object-fit: cover;
        }

        .wishlist-product-card .card-body {
            display: flex;
            flex-direction: column;
        }

        .wishlist-product-card .product-title {
            flex-grow: 1;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .wishlist-product-card .card-footer .d-flex > * {
            flex-grow: 1;
        }

    .messages-accordion .accordion-item {
        background-color: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px !important;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .messages-accordion .accordion-button {
        font-weight: 600;
        color: var(--text-dark);
        background-color: #f8f9fa;
        border-radius: 8px 8px 0 0 !important;
    }

        .messages-accordion .accordion-button:not(.collapsed) {
            color: var(--primary-color);
            background-color: #e9f0f8;
            box-shadow: none;
        }

        .messages-accordion .accordion-button::after {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%232c5aa0'%3e%3cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3e%3c/svg%3e");
        }

    .messages-accordion .accordion-body {
        color: var(--text-light);
        line-height: 1.7;
        background-color: #fff;
    }

    .message-source {
        font-size: 0.9rem;
        font-weight: 500;
    }

    .message-date {
        font-size: 0.85rem;
    }

    .profile-info-card .info-label {
        font-weight: 600;
        color: var(--text-light);
    }

    .profile-info-card .info-value {
        font-weight: 500;
        color: var(--text-dark);
    }

    .role-badge {
        font-size: 0.9rem;
        padding: 0.4em 0.8em;
    }
</style>

<section class="profile-page-section">
    <div class="container">
        <div class="profile-card-advanced">
            <div class="profile-sidebar">
                <form id="profile-picture-form" enctype="multipart/form-data">
                    @Html.AntiForgeryToken()
                    <div class="profile-avatar-wrapper">
                        <div id="profileAvatar" class="profile-avatar" style="background-image: url('@(string.IsNullOrEmpty(Model.ProfilePictureUrl) ? "/images/default-avatar.png" : Model.ProfilePictureUrl)')"></div>
                        <label for="profilePictureInput" class="profile-avatar-edit" title="Change picture">
                            <i class="fas fa-camera"></i>
                        </label>
                        <input type="file" id="profilePictureInput" name="profilePicture" class="d-none" accept="image/png, image/jpeg, image/gif">
                    </div>
                </form>
                <h5 class="profile-user-name">@Model.FullName</h5>
                <p class="profile-user-username">@@@Model.Username</p>

                <nav class="nav profile-nav flex-column" id="profileTab" role="tablist">
                    <a class="nav-link active" id="info-tab" data-bs-toggle="tab" href="#info-tab-pane" role="tab" aria-controls="info-tab-pane" aria-selected="true">
                        <i class="fas fa-user-edit fa-fw"></i> <span data-ar="المعلومات الشخصية" data-en="Personal Info">Personal Info</span>
                    </a>
                    <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders-tab-pane" role="tab" aria-controls="orders-tab-pane" aria-selected="false">
                        <i class="fas fa-box-open fa-fw"></i> <span data-ar="طلباتي" data-en="My Orders">My Orders</span>
                    </a>
                    <a class="nav-link" id="messages-tab" data-bs-toggle="tab" href="#messages-tab-pane" role="tab" aria-controls="messages-tab-pane" aria-selected="false">
                        <i class="fas fa-envelope-open-text fa-fw"></i> <span data-ar="رسائلي" data-en="My Messages">My Messages</span>
                    </a>
                    <a class="nav-link" id="wishlist-tab" data-bs-toggle="tab" href="#wishlist-tab-pane" role="tab" aria-controls="wishlist-tab-pane" aria-selected="false">
                        <i class="fas fa-heart fa-fw"></i> <span data-ar="المفضلة" data-en="Wishlist">Wishlist</span>
                    </a>
                </nav>
            </div>

            <div class="profile-content">
                <div class="tab-content" id="profileTabContent">
                    <!-- Personal Info Tab (REDESIGNED) -->
                    <div class="tab-pane fade show active" id="info-tab-pane" role="tabpanel" aria-labelledby="info-tab" tabindex="0">

                        <!-- Display User Info Section -->
                        <div class="card profile-info-card mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0" data-ar="معلوماتي" data-en="My Information">My Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-sm-3 info-label" data-ar="الاسم الكامل" data-en="Full Name">Full Name</div>
                                    <div class="col-sm-9 info-value">@Model.FullName</div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3 info-label" data-ar="اسم المستخدم" data-en="Username">Username</div>
                                    <div class="col-sm-9 info-value">@Model.Username</div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3 info-label" data-ar="البريد الإلكتروني" data-en="Email">Email</div>
                                    <div class="col-sm-9 info-value">@Model.Email</div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3 info-label" data-ar="رقم الهاتف" data-en="Phone Number">Phone Number</div>
                                    <div class="col-sm-9 info-value">@(Model.PhoneNumber ?? "Not provided")</div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-sm-3 info-label" data-ar="نوع العضوية" data-en="Membership">Membership</div>
                                    <div class="col-sm-9 info-value">
                                        @foreach (var role in Model.Roles)
                                        {
                                            <!-- <-- تم التعديل هنا: إضافة الترجمة للشارة -->
                                            <span class="badge role-badge bg-primary" data-en="@role" data-ar="@(roleTranslations.ContainsKey(role) ? roleTranslations[role] : role)">@role</span>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Edit User Info Section -->
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="alert alert-success mt-3" role="alert">@TempData["SuccessMessage"]</div>
                        }
                        <div asp-validation-summary="All" class="text-danger mb-3" role="alert"></div>

                        <form asp-action="Profile" method="post">
                            <h5 class="mt-4" data-ar="تعديل المعلومات" data-en="Edit Information">Edit Information</h5>
                            <div class="row mb-3 mt-3">
                                <label asp-for="FullName" class="col-sm-3 col-form-label" data-ar="الاسم الكامل" data-en="Full Name">Full Name</label>
                                <div class="col-sm-9">
                                    <input asp-for="FullName" class="form-control">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label asp-for="Email" class="col-sm-3 col-form-label" data-ar="البريد الإلكتروني" data-en="Email">Email</label>
                                <div class="col-sm-9">
                                    <input asp-for="Email" class="form-control">
                                </div>
                            </div>
                            <div class="row mb-4">
                                <label asp-for="PhoneNumber" class="col-sm-3 col-form-label" data-ar="رقم الهاتف" data-en="Phone Number">Phone Number</label>
                                <div class="col-sm-9">
                                    <input asp-for="PhoneNumber" class="form-control">
                                </div>
                            </div>
                            <hr>
                            <h5 class="mt-4" data-ar="تغيير كلمة المرور" data-en="Change Password">Change Password</h5>
                            <p class="text-muted small" data-ar="اترك الحقول فارغة إذا كنت لا ترغب في تغييرها." data-en="Leave fields blank if you don't want to change it.">Leave fields blank if you don't want to change it.</p>
                            <div class="row mb-3 mt-3">
                                <label asp-for="OldPassword" class="col-sm-3 col-form-label" data-ar="كلمة المرور الحالية" data-en="Current password">Current password</label>
                                <div class="col-sm-9">
                                    <input asp-for="OldPassword" class="form-control" autocomplete="current-password">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label asp-for="NewPassword" class="col-sm-3 col-form-label" data-ar="كلمة المرور الجديدة" data-en="New password">New password</label>
                                <div class="col-sm-9">
                                    <input asp-for="NewPassword" class="form-control" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <label asp-for="ConfirmPassword" class="col-sm-3 col-form-label" data-ar="تأكيد كلمة المرور" data-en="Confirm new password">Confirm new password</label>
                                <div class="col-sm-9">
                                    <input asp-for="ConfirmPassword" class="form-control" autocomplete="new-password">
                                </div>
                            </div>
                            <div class="text-end d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary" data-ar="حفظ التغييرات" data-en="Save Changes">Save Changes</button>
                            </div>
                        </form>
                    </div>


                    <!-- My Orders Tab -->
                    <div class="tab-pane fade" id="orders-tab-pane" role="tabpanel" aria-labelledby="orders-tab" tabindex="0">
                        <h4 data-ar="طلباتي السابقة" data-en="My Past Orders">My Past Orders</h4>
                        @if (Model.Orders.Any())
                        {
                            <div class="table-responsive mt-3">
                                <table class="table table-hover align-middle">
                                    <thead>
                                        <tr>
                                            <th scope="col" data-ar="رقم الطلب" data-en="Order ID">Order ID</th>
                                            <th scope="col" data-ar="التاريخ" data-en="Date">Date</th>
                                            <th scope="col" data-ar="الإجمالي" data-en="Total">Total</th>
                                            <th scope="col" data-ar="الحالة" data-en="Status">Status</th>
                                            <th scope="col"></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in Model.Orders)
                                        {
                                            <tr>
                                                <td>#@order.OrderId</td>
                                                <td>@order.OrderDate.ToString("yyyy-MM-dd")</td>
                                                <td>$@order.TotalAmount.ToString("F2")</td>
                                                <td><span class="badge bg-warning text-dark">@order.OrderStatus</span></td>
                                                <td class="text-end">
                                                    <a asp-controller="Orders" asp-action="Details" asp-route-id="@order.OrderId" class="btn btn-sm btn-outline-primary" data-ar="التفاصيل" data-en="Details">Details</a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fas fa-receipt fa-3x text-muted mb-3"></i>
                                <p class="mt-3 text-muted" data-ar="لم تقم بأي طلبات بعد." data-en="You have not placed any orders yet.">You have not placed any orders yet.</p>
                            </div>
                        }
                    </div>

                    <!-- My Messages Tab -->
                    <div class="tab-pane fade" id="messages-tab-pane" role="tabpanel" aria-labelledby="messages-tab" tabindex="0">
                        <h4 data-ar="الرسائل المرسلة" data-en="Submitted Messages">Submitted Messages</h4>
                        @if (Model.Messages.Any())
                        {
                            <div class="accordion messages-accordion mt-4" id="messagesAccordion">
                                @foreach (var (message, index) in Model.Messages.Select((value, i) => (value, i)))
                                {
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="heading-@index">
                                            <button class="accordion-button @(index == 0 ? "" : "collapsed")" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-@index" aria-expanded="@(index == 0 ? "true" : "false")" aria-controls="collapse-@index">
                                                <div class="d-flex justify-content-between w-100">
                                                    <span class="message-source">
                                                        <span data-ar="رسالة بخصوص:" data-en="Message regarding:">Message regarding:</span>
                                                        <strong>@message.SourcePage</strong>
                                                    </span>
                                                    <span class="message-date text-muted">@message.SubmittedAt.ToLocalTime().ToString("yyyy-MM-dd hh:mm tt")</span>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="collapse-@index" class="accordion-collapse collapse @(index == 0 ? "show" : "")" aria-labelledby="heading-@index" data-bs-parent="#messagesAccordion">
                                            <div class="accordion-body">
                                                @message.Message
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                                <p class="mt-3 text-muted" data-ar="لم تقم بإرسال أي رسائل بعد." data-en="You have not sent any messages yet.">You have not sent any messages yet.</p>
                            </div>
                        }
                    </div>

                    <!-- Wishlist Tab -->
                    <div class="tab-pane fade" id="wishlist-tab-pane" role="tabpanel" aria-labelledby="wishlist-tab" tabindex="0">
                        <h4 data-ar="قائمة المفضلة" data-en="My Wishlist">My Wishlist</h4>
                        @if (Model.WishlistItems.Any())
                        {
                            <div class="row mt-3 g-4" id="wishlist-items-container">
                                @foreach (var product in Model.WishlistItems)
                                {
                                    <div class="col-md-6 col-lg-4" id="wishlist-item-@product.Id">
                                        <div class="card wishlist-product-card h-100">
                                            <a asp-controller="Products" asp-action="Details" asp-route-id="@product.Id">
                                                <img src="/images/products/@product.ImageUrl" class="card-img-top product-image" alt="@product.NameEn">
                                            </a>
                                            <div class="card-body">
                                                <h6 class="product-title">
                                                    <a asp-controller="Products" asp-action="Details" asp-route-id="@product.Id" class="text-dark text-decoration-none" data-en="@product.NameEn" data-ar="@product.NameAr">@product.NameEn</a>
                                                </h6>
                                                <div class="price-section mt-2">
                                                    <span class="current-price fs-5">$@product.PriceAfterDiscount.ToString("F2")</span>
                                                </div>
                                            </div>
                                            <div class="card-footer bg-white border-0 pt-0">
                                                <div class="d-flex gap-2">
                                                    <a asp-controller="Products" asp-action="Details" asp-route-id="@product.Id" class="btn btn-sm btn-outline-primary" data-en="View" data-ar="عرض">View</a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger remove-wishlist-item" data-product-id="@product.Id">
                                                        <i class="fas fa-trash-alt me-1"></i> <span data-en="Remove" data-ar="إزالة">Remove</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5" id="empty-wishlist-msg">
                                <i class="fas fa-heart-crack fa-3x text-muted mb-3"></i>
                                <p class="mt-3 text-muted" data-ar="قائمة المفضلة فارغة." data-en="Your wishlist is empty.">Your wishlist is empty.</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const profilePictureInput = document.getElementById('profilePictureInput');
            const profileAvatar = document.getElementById('profileAvatar');
            const form = document.getElementById('profile-picture-form');
            const token = form.querySelector('input[name="__RequestVerificationToken"]').value;

            profilePictureInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    const formData = new FormData();
                    formData.append('profilePicture', file);
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        profileAvatar.style.backgroundImage = `url('${e.target.result}')`;
                    }
                    reader.readAsDataURL(file);

                    fetch('/Account/UploadProfilePicture', {
                        method: 'POST',
                        headers: { 'RequestVerificationToken': token },
                        body: formData
                    })
                    .then(response => response.ok ? response.json() : Promise.reject(response))
                    .then(data => {
                        if (data.newImageUrl) {
                            profileAvatar.style.backgroundImage = `url('${data.newImageUrl}')`;
                        } else {
                            alert(data.message || 'Upload failed');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred during upload. Please try again.');
                    });
                }
            });

            const hash = window.location.hash;
            if (hash) {
                const tabTrigger = document.querySelector(`.nav-link[href="${hash}"]`);
                if (tabTrigger) {
                    const tab = new bootstrap.Tab(tabTrigger);
                    tab.show();
                }
            }

            const wishlistContainer = document.getElementById('wishlist-items-container');
            if (wishlistContainer) {
                wishlistContainer.addEventListener('click', function(e) {
                    const removeButton = e.target.closest('.remove-wishlist-item');
                    if (!removeButton) return;

                    const productId = removeButton.dataset.productId;
                    const cardToRemove = document.getElementById(`wishlist-item-${productId}`);

                    fetch(`/api/Wishlist/Remove/${productId}`, {
                        method: 'DELETE',
                        headers: {
                            'RequestVerificationToken': token
                        }
                    })
                    .then(response => {
                        if (response.ok) {
                            cardToRemove.style.transition = 'opacity 0.5s ease';
                            cardToRemove.style.opacity = '0';
                            setTimeout(() => {
                                cardToRemove.remove();
                                const favCount = document.getElementById('fav-count');
                                if (favCount) {
                                    let currentCount = parseInt(favCount.textContent);
                                    favCount.textContent = Math.max(0, currentCount - 1);
                                }
                                if (wishlistContainer.children.length === 0) {
                                    document.getElementById('empty-wishlist-msg').style.display = 'block';
                                }
                            }, 500);
                        } else {
                            alert('Failed to remove item. Please try again.');
                        }
                    })
                    .catch(error => console.error('Error removing wishlist item:', error));
                });
            }
        });
    </script>
}
